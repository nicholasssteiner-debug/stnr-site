<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Colaborativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 
      ‚úÖ PASSO 1: CONFIGURA√á√ÉO PARA USO LOCAL (NO SEU COMPUTADOR)
      Se voc√™ salvar este arquivo e abri-lo no seu navegador, precisar√° preencher a configura√ß√£o abaixo.
      
      COMO FAZER:
      1. Crie um projeto no Firebase: https://firebase.google.com/
      2. No painel do seu projeto, clique no √≠cone de engrenagem (Configura√ß√µes do Projeto).
      3. Na aba "Geral", role para baixo at√© a se√ß√£o "Seus apps".
      4. Clique no √≠cone "</>" para "Adicionar um app da Web".
      5. D√™ um nome ao seu app e clique em "Registrar app".
      6. O Firebase mostrar√° um objeto de configura√ß√£o chamado `firebaseConfig`. Copie esse objeto.
      7. Cole o objeto que voc√™ copiou abaixo, substituindo o conte√∫do de `window.firebaseConfig`.
    -->
    <script>
        // SUAS CHAVES DO FIREBASE FORAM INSERIDAS AQUI
        window.firebaseConfig = {
          apiKey: "AIzaSyB7ov_J4nPV2XKmKaRhozTFdMB_3-sI6bY",
          authDomain: "mapa-de-analise-por-conta.firebaseapp.com",
          projectId: "mapa-de-analise-por-conta",
          storageBucket: "mapa-de-analise-por-conta.firebasestorage.app",
          messagingSenderId: "181460577763",
          appId: "1:181460577763:web:5f7821f5a597dcfd44c4d6",
          measurementId: "G-HL4MBDKSFZ"
        };
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .card-filter {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .card-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .card-filter.active {
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }
        .settled td {
            text-decoration: line-through;
            color: #6b7280;
        }
        .settle-btn {
            background-color: #4b5563;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .settle-btn:hover {
            background-color: #6b7280;
        }
        tr.settled .settle-btn {
            background-color: #22c55e;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; border: 2px solid #1f2937; }
        ::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }
        #session-id-display { user-select: all; }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">

        <!-- Se√ß√£o de Sess√£o Colaborativa -->
        <div id="session-container" class="card p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">Colabora√ß√£o em Tempo Real</h2>
            <div id="create-session-view">
                <p class="text-gray-400 mb-4">Para come√ßar, carregue um arquivo CSV para criar uma nova sess√£o de an√°lise e compartilhe o ID com sua equipe.</p>
                <input type="file" id="csv-file" class="hidden" accept=".csv">
                <button id="create-session-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors" disabled>
                    Autenticando...
                </button>
            </div>
             <div id="join-session-view" class="mt-6 border-t border-gray-700 pt-6">
                 <p class="text-gray-400 mb-4">Ou, se voc√™ tem um ID de sess√£o, cole-o abaixo para entrar.</p>
                 <div class="flex gap-2">
                     <input type="text" id="session-id-input" placeholder="Cole o ID da sess√£o aqui" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                     <button id="join-session-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled>Entrar</button>
                 </div>
            </div>
            <div id="loading-state" class="hidden text-center py-4">
                <p class="text-lg animate-pulse">Processando...</p>
            </div>
        </div>
        
        <!-- Informa√ß√£o da Sess√£o Ativa -->
        <div id="active-session-info" class="hidden card p-4 rounded-lg mb-8 bg-gray-900">
             <p class="text-sm text-gray-400">Voc√™ est√° na sess√£o (clique no ID para copiar): 
                <strong id="session-id-display" class="text-lg text-yellow-400 font-mono cursor-pointer" title="Clique para copiar"></strong>
            </p>
             <p class="text-xs text-gray-500 mt-2">Seu ID de usu√°rio: <span id="user-id-display" class="font-mono"></span></p>
        </div>


        <!-- Conte√∫do do Dashboard (inicialmente oculto) -->
        <div id="dashboard-content" class="hidden">
            <!-- Cabe√ßalho e Controles -->
            <header class="mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-white">Mapa de An√°lise por Conta</h1>
                        <p id="account-number" class="text-lg text-gray-400">Carregando...</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="export-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled>
                            Exportar CSV com Altera√ß√µes
                        </button>
                    </div>
                </div>
                <div class="mt-6">
                    <label for="supplier-filter" class="block text-sm font-medium text-gray-300 mb-2">Filtrar por Fornecedor:</label>
                    <select id="supplier-filter" class="w-full md:w-1/3 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="all">Todos os Fornecedores</option>
                    </select>
                </div>
            </header>

            <!-- M√©tricas Principais (KPIs) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Cards de KPI -->
                <div class="card p-6 rounded-xl shadow-lg flex items-center space-x-4">
                    <div class="bg-blue-500 bg-opacity-20 p-3 rounded-full"><svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2-1.343-2-3-2m0 0c-1.11 0-2.08-.402-2.599-1M12 4v1m0 14v1m-6-7h.01M6 12a2 2 0 11-4 0 2 2 0 014 0zm12 0h.01M18 12a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                    <div><p class="text-sm text-gray-400">Total a acertar</p><p id="total-value" class="text-2xl font-bold text-white">R$ 0,00</p></div>
                </div>
                <div class="card p-6 rounded-xl shadow-lg flex items-center space-x-4">
                    <div class="bg-green-500 bg-opacity-20 p-3 rounded-full"><svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div>
                    <div><p class="text-sm text-gray-400">Total de Lan√ßamentos</p><p id="total-entries" class="text-2xl font-bold text-white">0</p></div>
                </div>
                <div class="card p-6 rounded-xl shadow-lg flex items-center space-x-4">
                    <div class="bg-purple-500 bg-opacity-20 p-3 rounded-full"><svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 4h5m-5 4h5"></path></svg></div>
                    <div><p class="text-sm text-gray-400">Fornecedores</p><p id="total-suppliers" class="text-2xl font-bold text-white">0</p></div>
                </div>
                <div id="overdue-card" class="card card-filter p-6 rounded-xl shadow-lg flex items-center space-x-4">
                    <div class="bg-red-500 bg-opacity-20 p-3 rounded-full"><svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <div><p class="text-sm text-gray-400">Lan√ßamentos Vencidos</p><p id="overdue-entries" class="text-2xl font-bold text-white">0</p></div>
                </div>
            </div>

            <!-- Gr√°ficos e Tabela -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2 card p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-white mb-4">Valor por Fornecedor</h2>
                    <div class="relative h-[32rem]">
                        <canvas id="suppliersChart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-3 card p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-white mb-4">Detalhes dos Lan√ßamentos</h2>
                    <div class="overflow-auto h-[32rem]">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-800 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Fornecedor</th>
                                    <th scope="col" class="px-4 py-3">Lan√ßamento</th>
                                    <th scope="col" class="px-4 py-3">Vencimento</th>
                                    <th scope="col" class="px-4 py-3">Descri√ß√£o</th>
                                    <th scope="col" class="px-4 py-3">Valor</th>
                                    <th scope="col" class="px-4 py-3">Status</th>
                                    <th scope="col" class="px-4 py-3">Observa√ß√£o Analista</th>
                                    <th scope="col" class="px-4 py-3">Observa√ß√£o Respons√°vel</th>
                                    <th scope="col" class="px-4 py-3 text-center">Acertar</th>
                                </tr>
                            </thead>
                            <tbody id="entries-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifica√ß√£o Toast -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-all duration-300 ease-in-out transform translate-y-16 opacity-0">
        Mensagem aqui!
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, writeBatch, collection, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARI√ÅVEIS GLOBAIS ---
        const fileInput = document.getElementById('csv-file');
        const createSessionBtn = document.getElementById('create-session-btn');
        const joinSessionBtn = document.getElementById('join-session-btn');
        const sessionIdInput = document.getElementById('session-id-input');
        const exportButton = document.getElementById('export-button');
        const supplierFilter = document.getElementById('supplier-filter');
        const tableBody = document.getElementById('entries-table');
        const accountNumberEl = document.getElementById('account-number');
        const overdueCard = document.getElementById('overdue-card');
        const sessionContainer = document.getElementById('session-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const activeSessionInfo = document.getElementById('active-session-info');
        const loadingState = document.getElementById('loading-state');

        let db, auth;
        let userId;
        let currentDashboardId = null;
        let unsubscribeFromEntries = null;

        let suppliersChartInstance = null;
        let fullDataset = [];
        let isOverdueFilterActive = false;

        let currentFirebaseConfig; 

        // --- INICIALIZA√á√ÉO DO FIREBASE ---
        async function initFirebase() {
            try {
                // Tenta usar a configura√ß√£o injetada pela plataforma.
                if (typeof __firebase_config !== 'undefined') {
                    currentFirebaseConfig = JSON.parse(__firebase_config);
                } 
                // Se n√£o estiver na plataforma, usa a configura√ß√£o definida no <head>.
                else {
                    currentFirebaseConfig = window.firebaseConfig;
                }
                
                // Valida se a configura√ß√£o √© v√°lida.
                if (!currentFirebaseConfig || !currentFirebaseConfig.apiKey || currentFirebaseConfig.apiKey.includes("COLE_SUA_API_KEY_AQUI")) {
                    console.error("Configura√ß√£o do Firebase n√£o encontrada ou n√£o preenchida.");
                    showToast("Erro: Preencha 'window.firebaseConfig' no <head> do HTML.", true);
                    return;
                }

                const app = initializeApp(currentFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        
                        // Enable UI
                        createSessionBtn.disabled = false;
                        joinSessionBtn.disabled = false;
                        createSessionBtn.textContent = 'Criar Nova Sess√£o com CSV';
                    } else {
                        // User is signed out, UI remains disabled.
                        console.log("Usu√°rio n√£o autenticado.");
                    }
                });

                // Attempt to sign in
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Falha ao inicializar o Firebase:", error);
                showToast("N√£o foi poss√≠vel conectar aos servi√ßos de colabora√ß√£o.", true);
                createSessionBtn.textContent = 'Erro na Conex√£o';
            }
        }

        // --- UTILITIES ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        const formatDate = (dateString) => (!dateString || dateString.trim() === '') ? 'N/A' : dateString;
        const getChartColors = (count) => {
            const colors = ['rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)'];
            return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
        };
        const generateRandomId = (length = 8) => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            if (!toast) return;
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            toast.classList.remove('hidden', 'opacity-0', 'translate-y-16');
            toast.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-16');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- L√ìGICA DE SESS√ÉO ---
        async function createSession() {
            if (!auth.currentUser) {
                showToast("Aguardando autentica√ß√£o...", true);
                return;
            }
            if (!fileInput.files[0]) {
                showToast("Por favor, selecione um arquivo CSV primeiro.", true);
                return;
            }
            showLoading(true);

            Papa.parse(fileInput.files[0], {
                delimiter: ";",
                encoding: "ISO-8859-1",
                complete: async (results) => {
                    const { records, accountNumber } = processCsvData(results.data);
                    if (records.length === 0) {
                        showToast("Nenhum dado v√°lido foi encontrado no arquivo.", true);
                        showLoading(false);
                        return;
                    }
                    
                    const newDashboardId = generateRandomId();
                    const appId = typeof __app_id !== 'undefined' ? __app_id : currentFirebaseConfig.projectId || 'default-app-id';
                    
                    try {
                        const batch = writeBatch(db);
                        const dashboardDocRef = doc(db, `/artifacts/${appId}/public/data/dashboards`, newDashboardId);
                        batch.set(dashboardDocRef, {
                            accountNumber: accountNumber || "N√£o encontrado",
                            createdAt: serverTimestamp(),
                            ownerId: userId
                        });

                        const entriesCollectionRef = collection(db, `/artifacts/${appId}/public/data/dashboards/${newDashboardId}/entries`);
                        records.forEach(record => {
                            const newEntryRef = doc(entriesCollectionRef);
                            batch.set(newEntryRef, {
                                ...record,
                                observation_responsible: record['Observa√ß√£o Respons√°vel'] || '',
                                is_settled: false,
                            });
                        });

                        await batch.commit();
                        joinSession(newDashboardId);

                    } catch (error) {
                        console.error("Erro ao criar sess√£o no Firestore:", error);
                        showToast("Falha ao salvar os dados. Verifique o console.", true);
                        showLoading(false);
                    }
                },
                error: (error) => {
                    console.error("Erro ao processar o CSV:", error);
                    showLoading(false);
                }
            });
        }
        
        async function joinSession(dashboardId) {
             if (!dashboardId || dashboardId.trim() === '') {
                showToast("Por favor, insira um ID de sess√£o v√°lido.", true);
                return;
            }
            showLoading(true);

            if (unsubscribeFromEntries) unsubscribeFromEntries();
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : currentFirebaseConfig.projectId || 'default-app-id';
            
            const dashboardDocRef = doc(db, `/artifacts/${appId}/public/data/dashboards`, dashboardId);
            const docSnap = await getDoc(dashboardDocRef);

            if (!docSnap.exists()) {
                showToast("Sess√£o n√£o encontrada. Verifique o ID e tente novamente.", true);
                showLoading(false);
                return;
            }
            
            currentDashboardId = dashboardId;
            const dashboardData = docSnap.data();
            accountNumberEl.textContent = `Conta: ${dashboardData.accountNumber}`;

            const entriesCollectionRef = collection(db, `/artifacts/${appId}/public/data/dashboards/${currentDashboardId}/entries`);

            unsubscribeFromEntries = onSnapshot(query(entriesCollectionRef), (snapshot) => {
                fullDataset = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (fullDataset.length > 0) {
                    initializeDashboard();
                } else {
                    renderEmptyState();
                }
                dashboardContent.classList.remove('hidden');
                sessionContainer.classList.add('hidden');
                activeSessionInfo.classList.remove('hidden');
                document.getElementById('session-id-display').textContent = currentDashboardId;
                showLoading(false);
            }, (error) => {
                console.error("Erro ao escutar por atualiza√ß√µes:", error);
                showToast("N√£o foi poss√≠vel conectar √† sess√£o.", true);
                showLoading(false);
            });
        }

        function showLoading(isLoading) {
            if (isLoading) {
                loadingState.classList.remove('hidden');
                document.getElementById('create-session-view').classList.add('hidden');
                document.getElementById('join-session-view').classList.add('hidden');
            } else {
                loadingState.classList.add('hidden');
                document.getElementById('create-session-view').classList.remove('hidden');
                document.getElementById('join-session-view').classList.remove('hidden');
            }
        }

        function processCsvData(data) {
            const records = [];
            let currentSupplierName = null, currentSupplierId = null, headers = [], accountNumber = null;

            data.forEach(row => {
                if (row.length < 1 || row.every(cell => cell === null || cell.trim() === '')) return;
                if (!accountNumber && row[0] && row[0].includes("Mapa de An√°lise")) {
                    const match = row[0].match(/Mapa de An√°lise (\d+)/);
                    if (match && match[1]) accountNumber = match[1];
                }
                const supplierMatch = row[0] && row[0].match(/(\d{14}|\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})\s*-\s*(.*)/);
                if (supplierMatch) {
                    currentSupplierId = supplierMatch[1].trim();
                    currentSupplierName = supplierMatch[2].trim();
                    return; 
                }
                if (row.some(h => h && h.trim().toLowerCase().includes('valor (r$)'))) {
                    headers = row.map(h => h ? h.trim() : '');
                    return; 
                }
                if (currentSupplierId && headers.length > 0) {
                    const record = {};
                    headers.forEach((header, index) => {
                       if(header) record[header] = row[index];
                    });
                    if (record['Lan√ßamento'] && record['Valor (R$)']) {
                        record.fornecedor = currentSupplierName;
                        record.fornecedorId = currentSupplierId;
                        const valorString = record['Valor (R$)'] || '0';
                        record.valor = parseFloat(valorString.replace('R$', '').trim().replace(/\./g, '').replace(',', '.')) || 0;
                        records.push(record);
                    }
                }
            });
            return { records, accountNumber };
        }

        // --- L√ìGICA DE EVENTOS DA UI ---
        document.addEventListener('DOMContentLoaded', initFirebase);
        createSessionBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', createSession);
        joinSessionBtn.addEventListener('click', () => joinSession(sessionIdInput.value));
        supplierFilter.addEventListener('change', applyFilters);
        exportButton.addEventListener('click', handleExport);
        overdueCard.addEventListener('click', toggleOverdueFilter);
        document.getElementById('session-id-display').addEventListener('click', (e) => {
            navigator.clipboard.writeText(e.target.textContent).then(() => {
                showToast('ID da sess√£o copiado!');
            });
        });
        tableBody.addEventListener('blur', async (event) => {
            const cell = event.target;
            if (cell.tagName === 'TD' && cell.isContentEditable) {
                const docId = cell.dataset.docId;
                const value = cell.textContent;
                if (docId) {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : currentFirebaseConfig.projectId || 'default-app-id';
                    const docRef = doc(db, `/artifacts/${appId}/public/data/dashboards/${currentDashboardId}/entries`, docId);
                    try {
                        await updateDoc(docRef, { observation_responsible: value });
                    } catch (error) {
                        console.error("Erro ao atualizar observa√ß√£o:", error);
                        cell.textContent = fullDataset.find(item => item.id === docId).observation_responsible; // Reverte
                    }
                }
            }
        }, true);
        tableBody.addEventListener('click', async (event) => {
            const button = event.target.closest('.settle-btn');
            if (button) {
                const docId = button.dataset.docId;
                if (docId) {
                    const currentItem = fullDataset.find(item => item.id === docId);
                    const newSettledState = !currentItem.is_settled;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : currentFirebaseConfig.projectId || 'default-app-id';
                    const docRef = doc(db, `/artifacts/${appId}/public/data/dashboards/${currentDashboardId}/entries`, docId);
                    try {
                        await updateDoc(docRef, { is_settled: newSettledState });
                    } catch (error) {
                        console.error("Erro ao atualizar status:", error);
                    }
                }
            }
        });
        
        // --- RENDERIZA√á√ÉO DO DASHBOARD ---
        function initializeDashboard() {
            exportButton.disabled = fullDataset.length === 0;
            const suppliersMap = new Map();
            fullDataset.forEach(item => suppliersMap.set(item.fornecedorId, item.fornecedor));
            const sortedSuppliers = [...suppliersMap.entries()].sort((a, b) => a[1].localeCompare(b[1]));
            supplierFilter.innerHTML = '<option value="all">Todos os Fornecedores</option>';
            sortedSuppliers.forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                supplierFilter.appendChild(option);
            });
            applyFilters();
        }

        const isItemOverdue = (item) => {
            const today = new Date();
            today.setHours(0,0,0,0);
            const vencimentoStr = item['Apontamento'];
            if(!vencimentoStr || vencimentoStr.trim() === '') return false;
            const [day, month, year] = vencimentoStr.split('/').map(Number);
            if (isNaN(day) || isNaN(month) || isNaN(year)) return false;
            return new Date(year, month - 1, day) < today;
        }

        function toggleOverdueFilter() {
            isOverdueFilterActive = !isOverdueFilterActive;
            overdueCard.classList.toggle('active', isOverdueFilterActive);
            applyFilters();
        }

        function applyFilters() {
            if (!fullDataset) return;
            const selectedSupplierId = supplierFilter.value;
            let filteredData = selectedSupplierId === 'all'
                ? fullDataset
                : fullDataset.filter(item => item.fornecedorId === selectedSupplierId);
            if (isOverdueFilterActive) {
                filteredData = filteredData.filter(isItemOverdue);
            }
            renderDashboard(filteredData);
        }
        
        function renderDashboard(data) {
            document.getElementById('total-value').textContent = formatCurrency(data.reduce((acc, item) => acc + item.valor, 0));
            document.getElementById('total-entries').textContent = data.length;
            document.getElementById('total-suppliers').textContent = new Set(data.map(item => item.fornecedorId)).size;
            const supplierFilteredData = supplierFilter.value === 'all' ? fullDataset : fullDataset.filter(item => item.fornecedorId === supplierFilter.value);
            document.getElementById('overdue-entries').textContent = supplierFilteredData.filter(isItemOverdue).length;

            const valueById = data.reduce((acc, item) => {
                const key = item.fornecedorId;
                if (!acc[key]) acc[key] = { name: item.fornecedor, value: 0 };
                acc[key].value += item.valor;
                return acc;
            }, {});
            const chartLabels = Object.values(valueById).map(s => s.name);
            const chartValues = Object.values(valueById).map(s => s.value);
            
            if (suppliersChartInstance) suppliersChartInstance.destroy();
            suppliersChartInstance = new Chart('suppliersChart', {
                type: 'bar',
                data: { 
                    labels: chartLabels, 
                    datasets: [{ 
                        label: 'Valor Total (R$)', data: chartValues, 
                        backgroundColor: getChartColors(chartLabels.length),
                        borderWidth: 1, borderRadius: 4, 
                    }] 
                },
                options: { 
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => formatCurrency(ctx.parsed.x) } } }, 
                    scales: { 
                        x: { ticks: { color: '#9ca3af', font: {size: 10} }, grid: { color: '#374151' } }, 
                        y: { ticks: { color: '#9ca3af', font: {size: 10} }, grid: { color: 'transparent' } } 
                    } 
                }
            });

            tableBody.innerHTML = ''; 
            if (data.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-gray-400">Nenhum lan√ßamento encontrado.</td></tr>`;
                 return;
            }

            data.forEach(item => {
                const isOverdue = isItemOverdue(item);
                const statusClass = isOverdue ? 'bg-red-500 text-red-100' : 'bg-green-500 text-green-100';
                const statusText = isOverdue ? 'Vencido' : 'Em dia';
                const row = document.createElement('tr');
                row.className = `border-b border-gray-700 hover:bg-gray-600 ${item.is_settled ? 'settled' : ''}`;
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-white">${item.fornecedor}</td>
                    <td class="px-4 py-3">${formatDate(item['Lan√ßamento'])}</td>
                    <td class="px-4 py-3">${formatDate(item['Apontamento'])}</td>
                    <td class="px-4 py-3">${item['Descri√ß√£o'] || 'N/A'}</td>
                    <td class="px-4 py-3">${formatCurrency(item.valor)}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span></td>
                    <td class="px-4 py-3">${item['Observa√ß√µes'] || ''}</td>
                    <td class="px-4 py-3 text-white bg-gray-900/50 rounded cursor-cell" contenteditable="true" data-doc-id="${item.id}">${item.observation_responsible || ''}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="settle-btn" data-doc-id="${item.id}">‚úî</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function renderEmptyState() {
            exportButton.disabled = true;
            document.getElementById('total-value').textContent = formatCurrency(0);
            document.getElementById('total-entries').textContent = 0;
            document.getElementById('total-suppliers').textContent = 0;
            document.getElementById('overdue-entries').textContent = 0;
            if (suppliersChartInstance) suppliersChartInstance.destroy();
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-gray-400">Nenhum dado na sess√£o atual.</td></tr>`;
        }
        
        function handleExport() {
            if (fullDataset.length === 0) return;
            const EXPORT_HEADERS = ['Lan√ßamento', 'Vencimento', 'Apontamento', 'Tempo Ap√≥s Vencimento', 'Valor (R$)', 'Descri√ß√£o', 'Observa√ß√µes', 'Observa√ß√£o Respons√°vel'];
            const groupedData = fullDataset.reduce((acc, item) => {
                const key = item.fornecedorId;
                if (!acc[key]) acc[key] = [];
                acc[key].push(item);
                return acc;
            }, {});
            let csvOutput = [];
            const accNumText = accountNumberEl.textContent.replace('Conta: ', '').trim();
            const period = new Date().toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric' });
            csvOutput.push([`üìë Mapa de An√°lise ${accNumText}`, ...Array(EXPORT_HEADERS.length - 2).fill(''), `Per√≠odo ${period}`]);
            csvOutput.push([]);
            const suppliersMap = new Map();
            fullDataset.forEach(item => suppliersMap.set(item.fornecedorId, item.fornecedor));
            const sortedSuppliers = [...suppliersMap.entries()].sort((a, b) => a[1].localeCompare(b[1]));

            sortedSuppliers.forEach(([supplierId, supplierName]) => {
                const items = groupedData[supplierId];
                if (!items) return;
                csvOutput.push([`${supplierId} - ${supplierName}`]);
                csvOutput.push(EXPORT_HEADERS);
                items.forEach(item => {
                    const row = [
                        item['Lan√ßamento'] || '', item['Vencimento'] || '', item['Apontamento'] || '',
                        item['Tempo Ap√≥s Vencimento'] || '', formatCurrency(item.valor), item['Descri√ß√£o'] || '',
                        item['Observa√ß√µes'] || '', item.observation_responsible || ''
                    ];
                    csvOutput.push(row);
                });
                csvOutput.push([]);
            });

            const csv = Papa.unparse(csvOutput, { delimiter: ";", header: false });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `mapa_analise_colaborativo_${currentDashboardId}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>

